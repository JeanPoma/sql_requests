name: Prevent Cross-Branch Pull Requests

on:
  pull_request:
    types: [opened, reopened]

jobs:
  check-branch-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR violates branch strategy
        id: check
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          HEAD_BRANCH="${{ github.head_ref }}"

          echo "Base branch: $BASE_BRANCH"
          echo "Head branch: $HEAD_BRANCH"

          # Check for postgres -> main
          if [[ "$BASE_BRANCH" == "main" && "$HEAD_BRANCH" == "postgres" ]]; then
            echo "violation=true" >> $GITHUB_OUTPUT
            echo "message=âŒ **Pull Request BloquÃ©e** : La branche \`postgres\` ne peut pas Ãªtre mergÃ©e dans \`main\`.|Ces branches reprÃ©sentent deux versions parallÃ¨les du projet (PostgreSQL vs MariaDB) et ne doivent pas Ãªtre fusionnÃ©es.|Consultez \`.github/BRANCH_STRATEGY.md\` pour plus d'informations." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for main -> postgres
          if [[ "$BASE_BRANCH" == "postgres" && "$HEAD_BRANCH" == "main" ]]; then
            echo "violation=true" >> $GITHUB_OUTPUT
            echo "message=âŒ **Pull Request BloquÃ©e** : La branche \`main\` ne peut pas Ãªtre mergÃ©e dans \`postgres\`.|Ces branches reprÃ©sentent deux versions parallÃ¨les du projet (MariaDB vs PostgreSQL) et ne doivent pas Ãªtre fusionnÃ©es.|Consultez \`.github/BRANCH_STRATEGY.md\` pour plus d'informations." >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "violation=false" >> $GITHUB_OUTPUT

      - name: Comment on PR if violation detected
        if: steps.check.outputs.violation == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `${{ steps.check.outputs.message }}`.split('|').join('\n\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message + '\n\n---\n\nðŸ“š **Ressources** :\n- [StratÃ©gie de Branches](.github/BRANCH_STRATEGY.md)\n- [Guide MariaDB vs PostgreSQL](docs/MARIADB_VS_POSTGRESQL.md)\n\nðŸ”„ **Action recommandÃ©e** : Fermez cette PR et crÃ©ez une nouvelle PR ciblant la bonne branche de base.'
            });

      - name: Close PR if violation detected
        if: steps.check.outputs.violation == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });

      - name: Fail workflow if violation detected
        if: steps.check.outputs.violation == 'true'
        run: |
          echo "::error::Cette PR viole la stratÃ©gie de branches du repository"
          exit 1
