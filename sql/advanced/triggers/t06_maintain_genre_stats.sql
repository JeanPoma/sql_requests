-- ============================================
-- EXERCICE: Trigger pour vue mat√©rialis√©e
-- NIVEAU: üî¥ Avanc√© - Triggers
-- CONCEPTS: Materialized views, denormalization, performance
--
-- üìö Documentation PostgreSQL :
-- - [CREATE TRIGGER](https://www.postgresql.org/docs/current/sql-createtrigger.html)
-- - [Materialized Views](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)
-- - [INSERT ON CONFLICT](https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT)
--
-- üéØ OBJECTIF P√âDAGOGIQUE:
-- Cr√©er une "vue mat√©rialis√©e" (table de statistiques)
-- maintenue automatiquement par des triggers.
--
-- üí° VUE MAT√âRIALIS√âE:
-- PostgreSQL a des vraies vues mat√©rialis√©es natives, mais
-- pour l'exercice, on simule avec table + triggers.
--
-- Avantages:
-- - Performance (pas de calcul √† chaque SELECT)
-- - Stats toujours √† jour (gr√¢ce aux triggers)
--
-- Inconv√©nients:
-- - Overhead sur INSERT/UPDATE/DELETE
-- - Complexit√© accrue
--
-- ‚ö†Ô∏è NOTE: En production PostgreSQL, pr√©f√©rez les vraies
-- MATERIALIZED VIEW avec REFRESH MATERIALIZED VIEW
--
-- ============================================
-- CONSIGNE:
-- Cr√©ez une table 'genre_stats' qui maintient des statistiques
-- par genre, puis une fonction trigger et un trigger pour la mettre √† jour.
--
-- √âtape 1: Cr√©er la table genre_stats
-- √âtape 2: Cr√©er la fonction trigger maintain_genre_stats
-- √âtape 3: Cr√©er le trigger trg_maintain_genre_stats_insert
--
-- Table: game_genres
-- Moment: AFTER INSERT
--
-- Action:
-- Recalculer les stats du genre concern√© et mettre √† jour genre_stats
-- en utilisant INSERT ... ON CONFLICT ... DO UPDATE
--
-- üí° SYNTAXE POSTGRESQL:
-- -- √âtape 1: Table de stats
-- CREATE TABLE IF NOT EXISTS genre_stats (
--     genre_id INT PRIMARY KEY,
--     genre_name VARCHAR(100),
--     total_games INT DEFAULT 0,
--     avg_metacritic DECIMAL(5,2),
--     last_updated TIMESTAMP DEFAULT NOW(),
--     FOREIGN KEY (genre_id) REFERENCES genres(id) ON DELETE CASCADE
-- );
--
-- -- √âtape 2: Fonction trigger
-- CREATE OR REPLACE FUNCTION maintain_genre_stats()
-- RETURNS TRIGGER
-- LANGUAGE plpgsql
-- AS \$\$
-- DECLARE
--     v_total INT;
--     v_avg DECIMAL(5,2);
--     v_genre_name VARCHAR(100);
-- BEGIN
--     -- R√©cup√©rer le nom du genre
--     SELECT name INTO v_genre_name FROM genres WHERE id = NEW.genre_id;
--
--     -- Calculer les stats
--     SELECT COUNT(*), ROUND(AVG(g.metacritic), 2)
--     INTO v_total, v_avg
--     FROM game_genres gg
--     JOIN games g ON gg.game_id = g.id
--     WHERE gg.genre_id = NEW.genre_id
--     AND g.metacritic IS NOT NULL;
--
--     -- Mettre √† jour ou ins√©rer (UPSERT)
--     INSERT INTO genre_stats (genre_id, genre_name, total_games, avg_metacritic, last_updated)
--     VALUES (NEW.genre_id, v_genre_name, v_total, v_avg, NOW())
--     ON CONFLICT (genre_id) DO UPDATE SET
--         total_games = EXCLUDED.total_games,
--         avg_metacritic = EXCLUDED.avg_metacritic,
--         last_updated = EXCLUDED.last_updated;
--
--     RETURN NEW;
-- END;
-- \$\$;
--
-- -- √âtape 3: Trigger
-- CREATE TRIGGER trg_maintain_genre_stats_insert
-- AFTER INSERT ON game_genres
-- FOR EACH ROW
-- EXECUTE FUNCTION maintain_genre_stats();
--
-- üí° UTILISATION:
-- -- Ajouter un jeu √† un genre
-- INSERT INTO game_genres (game_id, genre_id) VALUES (123, 5);
--
-- -- V√©rifier les stats
-- SELECT * FROM genre_stats WHERE genre_id = 5;
--
-- ‚ö†Ô∏è DIFF√âRENCES POSTGRESQL vs MariaDB:
-- 1. ON CONFLICT DO UPDATE au lieu de ON DUPLICATE KEY UPDATE
-- 2. EXCLUDED pour r√©f√©rencer les valeurs tent√©es
-- 3. TIMESTAMP au lieu de DATETIME
-- 4. Fonction s√©par√©e (RETURNS TRIGGER)
--
-- üí° INSERT ON CONFLICT (UPSERT):
-- PostgreSQL utilise ON CONFLICT pour les "UPSERT":
-- - Si la cl√© primaire existe ‚Üí UPDATE
-- - Si la cl√© primaire n'existe pas ‚Üí INSERT
--
-- EXCLUDED fait r√©f√©rence aux valeurs de la ligne tent√©e:
-- INSERT INTO t VALUES (1, 'new')
-- ON CONFLICT (id) DO UPDATE SET col = EXCLUDED.col
--                                    -- ^^^^^^^^ valeur 'new'
--
-- üí° POUR ALLER PLUS LOIN:
-- Dans un syst√®me complet, il faudrait aussi des triggers pour:
-- - AFTER UPDATE sur games (quand metacritic change)
-- - AFTER DELETE sur game_genres
-- - AFTER DELETE sur games
--
-- üí° ALTERNATIVE: VRAIE VUE MAT√âRIALIS√âE PostgreSQL
-- CREATE MATERIALIZED VIEW genre_stats AS
-- SELECT g.id as genre_id, g.name as genre_name,
--        COUNT(*) as total_games,
--        ROUND(AVG(ga.metacritic), 2) as avg_metacritic
-- FROM genres g
-- JOIN game_genres gg ON g.id = gg.genre_id
-- JOIN games ga ON gg.game_id = ga.id
-- WHERE ga.metacritic IS NOT NULL
-- GROUP BY g.id, g.name;
--
-- -- Rafra√Æchir
-- REFRESH MATERIALIZED VIEW genre_stats;
--
-- -- Rafra√Æchir sans bloquer les lectures
-- REFRESH MATERIALIZED VIEW CONCURRENTLY genre_stats;
--
-- üí° CAS D'USAGE:
-- - Dashboards temps r√©el
-- - Leaderboards
-- - Statistiques complexes co√ªteuses √† calculer
-- - Cache de donn√©es agr√©g√©es
-- ============================================

