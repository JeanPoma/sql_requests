-- ============================================
-- EXERCICE: Trigger pour vue matÃ©rialisÃ©e
-- NIVEAU: ðŸ”´ AvancÃ© - Triggers
-- CONCEPTS: Materialized views, denormalization, performance
--
-- ðŸ“š Documentation MariaDB :
-- - [CREATE TRIGGER](https://mariadb.com/kb/en/create-trigger/)
-- - [INSERT ON DUPLICATE KEY UPDATE](https://mariadb.com/kb/en/insert-on-duplicate-key-update/)
--
-- ðŸŽ¯ OBJECTIF PÃ‰DAGOGIQUE:
-- CrÃ©er une "vue matÃ©rialisÃ©e" (table de statistiques)
-- maintenue automatiquement par des triggers.
--
-- ðŸ’¡ VUE MATÃ‰RIALISÃ‰E:
-- MariaDB n'a pas de vraies vues matÃ©rialisÃ©es, mais on peut
-- les simuler avec:
-- - Une table de stats
-- - Des triggers qui la mettent Ã  jour automatiquement
--
-- Avantages:
-- - Performance (pas de calcul Ã  chaque SELECT)
-- - Stats toujours Ã  jour
--
-- InconvÃ©nients:
-- - Overhead sur INSERT/UPDATE/DELETE
-- - ComplexitÃ© accrue
--
-- ============================================
-- CONSIGNE:
-- CrÃ©ez une table 'genre_stats' qui maintient des statistiques
-- par genre, puis des triggers pour la mettre Ã  jour.
--
-- Ã‰tape 1: CrÃ©er la table genre_stats
-- CREATE TABLE IF NOT EXISTS genre_stats (
--     genre_id INT PRIMARY KEY,
--     genre_name VARCHAR(100),
--     total_games INT DEFAULT 0,
--     avg_metacritic DECIMAL(5,2),
--     last_updated DATETIME,
--     FOREIGN KEY (genre_id) REFERENCES genres(id) ON DELETE CASCADE
-- );
--
-- Ã‰tape 2: CrÃ©er le trigger pour INSERT
-- Nom: trg_maintain_genre_stats_insert
-- Table: game_genres
-- Moment: AFTER INSERT
--
-- Action:
-- Recalculer les stats du genre concernÃ© et mettre Ã  jour genre_stats
-- en utilisant INSERT ... ON DUPLICATE KEY UPDATE
--
-- ðŸ’¡ SYNTAXE:
-- DELIMITER //
-- CREATE TRIGGER trg_maintain_genre_stats_insert
-- AFTER INSERT ON game_genres
-- FOR EACH ROW
-- BEGIN
--     -- Variables pour stocker les stats
--     DECLARE v_total INT;
--     DECLARE v_avg DECIMAL(5,2);
--     DECLARE v_genre_name VARCHAR(100);
--
--     -- RÃ©cupÃ©rer le nom du genre
--     SELECT name INTO v_genre_name FROM genres WHERE id = NEW.genre_id;
--
--     -- Calculer les stats
--     SELECT COUNT(*), ROUND(AVG(g.metacritic), 2)
--     INTO v_total, v_avg
--     FROM game_genres gg
--     JOIN games g ON gg.game_id = g.id
--     WHERE gg.genre_id = NEW.genre_id
--     AND g.metacritic IS NOT NULL;
--
--     -- Mettre Ã  jour ou insÃ©rer
--     INSERT INTO genre_stats (genre_id, genre_name, total_games, avg_metacritic, last_updated)
--     VALUES (NEW.genre_id, v_genre_name, v_total, v_avg, NOW())
--     ON DUPLICATE KEY UPDATE
--         total_games = v_total,
--         avg_metacritic = v_avg,
--         last_updated = NOW();
-- END //
-- DELIMITER ;
--
-- ðŸ’¡ INSERT ON DUPLICATE KEY UPDATE:
-- Cette syntaxe permet de faire un "UPSERT":
-- - Si la clÃ© primaire existe â†’ UPDATE
-- - Si la clÃ© primaire n'existe pas â†’ INSERT
--
-- TrÃ¨s utile pour maintenir des tables de stats.
--
-- ðŸ’¡ UTILISATION:
-- -- Ajouter un jeu Ã  un genre
-- INSERT INTO game_genres (game_id, genre_id) VALUES (123, 5);
--
-- -- VÃ©rifier les stats
-- SELECT * FROM genre_stats WHERE genre_id = 5;
--
-- ðŸ’¡ POUR ALLER PLUS LOIN:
-- Dans un systÃ¨me complet, il faudrait aussi des triggers pour:
-- - AFTER UPDATE sur games (quand metacritic change)
-- - AFTER DELETE sur game_genres
-- - AFTER DELETE sur games
--
-- ðŸ’¡ ALTERNATIVE: RECALCUL PÃ‰RIODIQUE
-- Au lieu de triggers (overhead sur chaque opÃ©ration),
-- on peut recalculer les stats pÃ©riodiquement (cron job):
-- - Plus simple
-- - Moins de load sur les Ã©critures
-- - Stats lÃ©gÃ¨rement en retard
--
-- ðŸ’¡ CAS D'USAGE:
-- - Dashboards temps rÃ©el
-- - Leaderboards
-- - Statistiques complexes coÃ»teuses Ã  calculer
-- ============================================

