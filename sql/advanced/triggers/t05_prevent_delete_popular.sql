-- ============================================
-- EXERCICE: Trigger BEFORE DELETE (protection)
-- NIVEAU: üî¥ Avanc√© - Triggers
-- CONCEPTS: BEFORE DELETE, protection, SIGNAL
--
-- üìö Documentation MariaDB :
-- - [CREATE TRIGGER](https://mariadb.com/kb/en/create-trigger/)
-- - [SIGNAL](https://mariadb.com/kb/en/signal/)
--
-- üéØ OBJECTIF P√âDAGOGIQUE:
-- Cr√©er un trigger qui emp√™che la suppression de donn√©es importantes
-- selon une r√®gle m√©tier.
--
-- üí° TRIGGERS DE PROTECTION:
-- Les triggers BEFORE DELETE peuvent emp√™cher des suppressions
-- accidentelles ou non autoris√©es en utilisant SIGNAL.
--
-- Cas d'usage:
-- - Emp√™cher suppression de donn√©es critiques
-- - Soft delete (marquer comme supprim√© au lieu de supprimer)
-- - V√©rifier des permissions m√©tier
--
-- ============================================
-- CONSIGNE:
-- Cr√©ez un trigger 'trg_prevent_delete_popular' qui emp√™che
-- la suppression de jeux tr√®s populaires.
--
-- Nom: trg_prevent_delete_popular
-- Table: games
-- Moment: BEFORE DELETE
--
-- R√®gle de protection:
-- Si OLD.ratings_count > 1000, alors emp√™cher la suppression
-- avec SIGNAL et message 'Cannot delete popular game with many ratings'
--
-- üí° SYNTAXE:
-- DELIMITER //
-- CREATE TRIGGER trg_prevent_delete_popular
-- BEFORE DELETE ON games
-- FOR EACH ROW
-- BEGIN
--     -- OLD contient les valeurs de la ligne √† supprimer
--     IF OLD.ratings_count > 1000 THEN
--         SIGNAL SQLSTATE '45000'
--         SET MESSAGE_TEXT = 'Cannot delete popular game with many ratings';
--     END IF;
-- END //
-- DELIMITER ;
--
-- üí° UTILISATION:
-- -- Essayer de supprimer un jeu populaire (devrait √©chouer)
-- DELETE FROM games WHERE id = 123 AND ratings_count > 1000;
-- -- Erreur: Cannot delete popular game with many ratings
--
-- -- Supprimer un jeu peu populaire (devrait r√©ussir)
-- DELETE FROM games WHERE id = 456 AND ratings_count <= 1000;
--
-- üí° ALTERNATIVE: SOFT DELETE
-- Au lieu d'emp√™cher la suppression, on peut faire un "soft delete":
-- - Ajouter une colonne 'deleted_at' √† la table
-- - Dans le trigger BEFORE DELETE, faire un UPDATE au lieu de DELETE
-- - Annuler le DELETE avec SIGNAL (ou le trigger ne fait rien)
--
-- Exemple de soft delete:
-- BEFORE DELETE ON games
-- BEGIN
--     UPDATE games SET deleted_at = NOW() WHERE id = OLD.id;
--     SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Soft deleted';
-- END
--
-- üí° ATTENTION:
-- - Le trigger s'applique √† TOUTES les suppressions (m√™me avec WHERE)
-- - Pensez aux suppressions en cascade (foreign keys)
-- - Pour d√©sactiver temporairement: DROP TRIGGER
--
-- üí° CAS D'USAGE:
-- - Protection contre suppressions accidentelles
-- - Conformit√© (conservation obligatoire de certaines donn√©es)
-- - Workflow d'approbation (seul un admin peut supprimer)
-- ============================================

