-- ============================================
-- EXERCICE: Trigger BEFORE DELETE (protection)
-- NIVEAU: üî¥ Avanc√© - Triggers
-- CONCEPTS: BEFORE DELETE, protection, RAISE EXCEPTION
--
-- üìö Documentation PostgreSQL :
-- - [CREATE TRIGGER](https://www.postgresql.org/docs/current/sql-createtrigger.html)
-- - [RAISE](https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html)
--
-- üéØ OBJECTIF P√âDAGOGIQUE:
-- Cr√©er un trigger qui emp√™che la suppression de donn√©es importantes
-- selon une r√®gle m√©tier.
--
-- üí° TRIGGERS DE PROTECTION:
-- Les triggers BEFORE DELETE peuvent emp√™cher des suppressions
-- accidentelles ou non autoris√©es en utilisant RAISE EXCEPTION.
--
-- Cas d'usage:
-- - Emp√™cher suppression de donn√©es critiques
-- - Soft delete (marquer comme supprim√© au lieu de supprimer)
-- - V√©rifier des permissions m√©tier
--
-- ============================================
-- CONSIGNE:
-- Cr√©ez une fonction trigger et un trigger qui emp√™che
-- la suppression de jeux tr√®s populaires.
--
-- √âtape 1: Cr√©er la fonction trigger prevent_delete_popular
-- √âtape 2: Cr√©er le trigger trg_prevent_delete_popular
--
-- Table: games
-- Moment: BEFORE DELETE
--
-- R√®gle de protection:
-- Si OLD.ratings_count > 1000, alors emp√™cher la suppression
-- avec RAISE EXCEPTION 'Cannot delete popular game with many ratings'
--
-- üí° SYNTAXE POSTGRESQL:
-- -- √âtape 1: Fonction trigger
-- CREATE OR REPLACE FUNCTION prevent_delete_popular()
-- RETURNS TRIGGER
-- LANGUAGE plpgsql
-- AS \$\$
-- BEGIN
--     -- OLD contient les valeurs de la ligne √† supprimer
--     IF OLD.ratings_count > 1000 THEN
--         RAISE EXCEPTION 'Cannot delete popular game with many ratings';
--     END IF;
--
--     RETURN OLD;  -- Autoriser la suppression
-- END;
-- \$\$;
--
-- -- √âtape 2: Trigger
-- CREATE TRIGGER trg_prevent_delete_popular
-- BEFORE DELETE ON games
-- FOR EACH ROW
-- EXECUTE FUNCTION prevent_delete_popular();
--
-- üí° UTILISATION:
-- -- Essayer de supprimer un jeu populaire (devrait √©chouer)
-- DELETE FROM games WHERE id = 123 AND ratings_count > 1000;
-- -- Erreur: Cannot delete popular game with many ratings
--
-- -- Supprimer un jeu peu populaire (devrait r√©ussir)
-- DELETE FROM games WHERE id = 456 AND ratings_count <= 1000;
--
-- ‚ö†Ô∏è DIFF√âRENCES POSTGRESQL vs MariaDB:
-- 1. RAISE EXCEPTION au lieu de SIGNAL SQLSTATE '45000'
-- 2. Fonction s√©par√©e (RETURNS TRIGGER)
-- 3. RETURN OLD pour valider (RETURN NULL pour annuler)
-- 4. Pas de SET MESSAGE_TEXT (message direct dans RAISE)
--
-- üí° ALTERNATIVE: SOFT DELETE
-- Au lieu d'emp√™cher la suppression, on peut faire un "soft delete":
-- - Ajouter une colonne 'deleted_at' √† la table
-- - Dans le trigger BEFORE DELETE, faire un UPDATE au lieu de DELETE
-- - Annuler le DELETE avec RETURN NULL
--
-- Exemple de soft delete:
-- CREATE OR REPLACE FUNCTION soft_delete_game()
-- RETURNS TRIGGER
-- LANGUAGE plpgsql
-- AS \$\$
-- BEGIN
--     UPDATE games
--     SET deleted_at = NOW()
--     WHERE id = OLD.id;
--
--     RETURN NULL;  -- Annuler le DELETE
-- END;
-- \$\$;
--
-- üí° RETURN dans BEFORE DELETE:
-- - RETURN OLD : autoriser la suppression
-- - RETURN NULL : annuler la suppression (soft delete)
-- - RAISE EXCEPTION : annuler avec erreur
--
-- üí° ATTENTION:
-- - Le trigger s'applique √† TOUTES les suppressions (m√™me avec WHERE)
-- - Pensez aux suppressions en cascade (foreign keys)
-- - Pour d√©sactiver temporairement: DROP TRIGGER ou ALTER TABLE DISABLE TRIGGER
--
-- üí° CAS D'USAGE:
-- - Protection contre suppressions accidentelles
-- - Conformit√© (conservation obligatoire de certaines donn√©es)
-- - Workflow d'approbation (seul un admin peut supprimer)
-- - Soft delete g√©n√©ralis√©
-- ============================================

