-- ============================================
-- EXERCICE: Trigger BEFORE INSERT (validation)
-- NIVEAU: üî¥ Avanc√© - Triggers
-- CONCEPTS: BEFORE INSERT, validation, RAISE EXCEPTION
--
-- üìö Documentation PostgreSQL :
-- - [CREATE TRIGGER](https://www.postgresql.org/docs/current/sql-createtrigger.html)
-- - [Trigger Functions](https://www.postgresql.org/docs/current/plpgsql-trigger.html)
-- - [RAISE](https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html)
--
-- üéØ OBJECTIF P√âDAGOGIQUE:
-- Cr√©er un trigger qui valide les donn√©es AVANT insertion
-- et emp√™che l'insertion si les donn√©es sont invalides.
--
-- üí° QU'EST-CE QU'UN TRIGGER ?
-- Un trigger est une proc√©dure qui s'ex√©cute automatiquement
-- en r√©ponse √† un √©v√©nement (INSERT, UPDATE, DELETE).
--
-- Types de triggers:
-- - BEFORE : s'ex√©cute AVANT l'op√©ration (peut modifier/rejeter)
-- - AFTER : s'ex√©cute APR√àS l'op√©ration (pour audit, notifications)
--
-- ‚ö†Ô∏è ARCHITECTURE POSTGRESQL:
-- 1. Cr√©er d'abord une FUNCTION qui retourne TRIGGER
-- 2. Cr√©er ensuite le TRIGGER qui appelle cette fonction
--
-- ============================================
-- CONSIGNE:
-- Cr√©ez un trigger 'trg_validate_game_insert' qui valide les donn√©es
-- avant l'insertion d'un nouveau jeu dans la table 'games'.
--
-- Nom fonction: validate_game_insert
-- Nom trigger: trg_validate_game_insert
-- Table: games
-- Moment: BEFORE INSERT
--
-- Validations:
-- 1. Le nom du jeu (NEW.name) ne doit pas √™tre vide
--    ‚Üí Si vide, RAISE EXCEPTION 'Game name cannot be empty'
--
-- 2. L'ann√©e (NEW.year) doit √™tre entre 1970 et l'ann√©e courante
--    ‚Üí Si invalide, RAISE EXCEPTION 'Invalid game year'
--
-- 3. Si metacritic est fourni, il doit √™tre entre 0 et 100
--    ‚Üí Si invalide, RAISE EXCEPTION 'Metacritic score must be between 0 and 100'
--
-- üí° SYNTAXE POSTGRESQL:
-- -- √âtape 1: Cr√©er la fonction trigger
-- CREATE OR REPLACE FUNCTION validate_game_insert()
-- RETURNS TRIGGER
-- LANGUAGE plpgsql
-- AS \$\$
-- BEGIN
--     -- NEW contient la nouvelle valeur √† ins√©rer
--
--     IF NEW.name IS NULL OR LENGTH(TRIM(NEW.name)) = 0 THEN
--         RAISE EXCEPTION 'Game name cannot be empty';
--     END IF;
--
--     IF NEW.year < 1970 OR NEW.year > EXTRACT(YEAR FROM CURRENT_DATE) THEN
--         RAISE EXCEPTION 'Invalid game year';
--     END IF;
--
--     IF NEW.metacritic IS NOT NULL AND (NEW.metacritic < 0 OR NEW.metacritic > 100) THEN
--         RAISE EXCEPTION 'Metacritic score must be between 0 and 100';
--     END IF;
--
--     RETURN NEW;  -- OBLIGATOIRE pour BEFORE triggers
-- END;
-- \$\$;
--
-- -- √âtape 2: Cr√©er le trigger
-- CREATE TRIGGER trg_validate_game_insert
-- BEFORE INSERT ON games
-- FOR EACH ROW
-- EXECUTE FUNCTION validate_game_insert();
--
-- üí° UTILISATION:
-- -- Cette insertion devrait r√©ussir
-- INSERT INTO games (name, year, metacritic) VALUES ('Valid Game', 2023, 85);
--
-- -- Cette insertion devrait √©chouer (nom vide)
-- INSERT INTO games (name, year, metacritic) VALUES ('', 2023, 85);
--
-- -- Cette insertion devrait √©chouer (ann√©e invalide)
-- INSERT INTO games (name, year, metacritic) VALUES ('Old Game', 1800, 85);
--
-- ‚ö†Ô∏è DIFF√âRENCES POSTGRESQL vs MariaDB:
-- 1. Fonction s√©par√©e obligatoire (RETURNS TRIGGER)
-- 2. RAISE EXCEPTION au lieu de SIGNAL SQLSTATE
-- 3. EXECUTE FUNCTION au lieu de code inline
-- 4. RETURN NEW obligatoire pour BEFORE triggers
-- 5. LENGTH(TRIM()) au lieu de = ''
-- 6. Pas de DELIMITER (utilise \$\$)
--
-- üí° RETURN dans triggers:
-- - BEFORE INSERT/UPDATE: RETURN NEW (valider/modifier)
-- - BEFORE INSERT/UPDATE: RETURN NULL (annuler l'op√©ration)
-- - BEFORE DELETE: RETURN OLD (valider)
-- - AFTER: RETURN NULL (valeur ignor√©e)
--
-- üí° NEW vs OLD:
-- - NEW : contient les nouvelles valeurs (INSERT, UPDATE)
-- - OLD : contient les anciennes valeurs (UPDATE, DELETE)
-- ============================================

