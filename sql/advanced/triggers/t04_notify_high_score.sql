-- ============================================
-- EXERCICE: Trigger AFTER UPDATE (notifications)
-- NIVEAU: ðŸ”´ AvancÃ© - Triggers
-- CONCEPTS: AFTER UPDATE, conditional logic, notifications
--
-- ðŸ“š Documentation PostgreSQL :
-- - [CREATE TRIGGER](https://www.postgresql.org/docs/current/sql-createtrigger.html)
-- - [Conditional Triggers](https://www.postgresql.org/docs/current/sql-createtrigger.html#SQL-CREATETRIGGER-NOTES)
--
-- ðŸŽ¯ OBJECTIF PÃ‰DAGOGIQUE:
-- CrÃ©er un trigger qui dÃ©tecte des Ã©vÃ©nements spÃ©cifiques
-- (ici: un jeu qui atteint un score exceptionnel) et enregistre
-- une notification.
--
-- ðŸ’¡ TRIGGERS POUR NOTIFICATIONS:
-- Les triggers peuvent dÃ©tecter des conditions mÃ©tier importantes
-- et dÃ©clencher des actions:
-- - Enregistrer dans une table de notifications
-- - IncrÃ©menter des compteurs
-- - Mettre Ã  jour des statistiques
--
-- ============================================
-- CONSIGNE:
-- CrÃ©ez une table 'notifications' puis une fonction trigger et un trigger
-- qui dÃ©tecte quand un jeu atteint un score Metacritic >= 95.
--
-- Ã‰tape 1: CrÃ©er la table notifications
-- Ã‰tape 2: CrÃ©er la fonction trigger notify_high_score
-- Ã‰tape 3: CrÃ©er le trigger trg_notify_high_score
--
-- Table: games
-- Moment: AFTER UPDATE
--
-- Action:
-- Si NEW.metacritic >= 95 ET (OLD.metacritic < 95 OU OLD.metacritic IS NULL),
-- alors insÃ©rer dans notifications:
-- - game_id: NEW.id
-- - game_name: NEW.name
-- - message: 'High score achieved: [score]'
-- - created_at: NOW()
--
-- ðŸ’¡ SYNTAXE POSTGRESQL:
-- -- Ã‰tape 1: Table notifications
-- CREATE TABLE IF NOT EXISTS notifications (
--     notif_id SERIAL PRIMARY KEY,
--     game_id INT,
--     game_name VARCHAR(255),
--     message TEXT,
--     created_at TIMESTAMP DEFAULT NOW()
-- );
-- CREATE INDEX IF NOT EXISTS idx_notif_time ON notifications(created_at);
--
-- -- Ã‰tape 2: Fonction trigger
-- CREATE OR REPLACE FUNCTION notify_high_score()
-- RETURNS TRIGGER
-- LANGUAGE plpgsql
-- AS \$\$
-- BEGIN
--     -- DÃ©tecter si le jeu vient d'atteindre un score >= 95
--     IF NEW.metacritic >= 95 AND
--        (OLD.metacritic IS NULL OR OLD.metacritic < 95)
--     THEN
--         INSERT INTO notifications (game_id, game_name, message, created_at)
--         VALUES (
--             NEW.id,
--             NEW.name,
--             'High score achieved: ' || NEW.metacritic,
--             NOW()
--         );
--     END IF;
--
--     RETURN NEW;
-- END;
-- \$\$;
--
-- -- Ã‰tape 3: Trigger
-- CREATE TRIGGER trg_notify_high_score
-- AFTER UPDATE ON games
-- FOR EACH ROW
-- EXECUTE FUNCTION notify_high_score();
--
-- ðŸ’¡ UTILISATION:
-- -- Mettre Ã  jour un jeu pour atteindre 95+
-- UPDATE games SET metacritic = 96 WHERE id = 123 AND (metacritic < 95 OR metacritic IS NULL);
--
-- -- VÃ©rifier les notifications
-- SELECT * FROM notifications ORDER BY created_at DESC;
--
-- âš ï¸ DIFFÃ‰RENCES POSTGRESQL vs MariaDB:
-- 1. || pour concatÃ©nation (au lieu de CONCAT)
-- 2. Fonction sÃ©parÃ©e (RETURNS TRIGGER)
-- 3. TEXT au lieu de TEXT (mÃªme chose mais explicite)
-- 4. TIMESTAMP au lieu de DATETIME
--
-- ðŸ’¡ POURQUOI AFTER UPDATE ?
-- AFTER UPDATE garantit que:
-- - La modification a bien Ã©tÃ© appliquÃ©e
-- - Les contraintes sont validÃ©es
-- - On peut utiliser NEW.id en toute sÃ©curitÃ©
--
-- ðŸ’¡ OPTIMISATION avec WHEN:
-- PostgreSQL permet d'ajouter une condition WHEN au trigger:
--
-- CREATE TRIGGER trg_notify_high_score
-- AFTER UPDATE OF metacritic ON games
-- FOR EACH ROW
-- WHEN (NEW.metacritic >= 95 AND (OLD.metacritic IS NULL OR OLD.metacritic < 95))
-- EXECUTE FUNCTION notify_high_score();
--
-- Cela Ã©vite d'appeler la fonction si la condition n'est pas remplie.
--
-- ðŸ’¡ CAS D'USAGE RÃ‰ELS:
-- - Alertes mÃ©tier (stock faible, seuil atteint)
-- - Gamification (badges, achievements)
-- - Monitoring (dÃ©tecter des anomalies)
-- - Notifications push/email (avec queue externe)
-- ============================================

