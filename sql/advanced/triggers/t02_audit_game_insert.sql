-- ============================================
-- EXERCICE: Trigger AFTER INSERT (audit log)
-- NIVEAU: üî¥ Avanc√© - Triggers
-- CONCEPTS: AFTER INSERT, audit trail, logging
--
-- üìö Documentation PostgreSQL :
-- - [CREATE TRIGGER](https://www.postgresql.org/docs/current/sql-createtrigger.html)
-- - [Trigger Functions](https://www.postgresql.org/docs/current/plpgsql-trigger.html)
-- - [NOW()](https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-CURRENT)
--
-- üéØ OBJECTIF P√âDAGOGIQUE:
-- Cr√©er un trigger qui enregistre automatiquement toutes les
-- insertions dans une table d'audit pour tra√ßabilit√©.
--
-- üí° AUDIT TRAIL:
-- Un audit trail (journal d'audit) enregistre toutes les modifications
-- dans la base de donn√©es : qui, quoi, quand.
--
-- Utilis√© pour:
-- - Tra√ßabilit√© (conformit√© RGPD, SOX, etc.)
-- - D√©bogage (quand une donn√©e a √©t√© ajout√©e ?)
-- - S√©curit√© (d√©tecter des modifications suspectes)
--
-- ============================================
-- CONSIGNE:
-- Cr√©ez d'abord une table d'audit 'games_audit', puis une fonction trigger
-- et un trigger qui enregistre chaque insertion.
--
-- √âtape 1: Cr√©er la table games_audit
-- √âtape 2: Cr√©er la fonction trigger audit_game_insert
-- √âtape 3: Cr√©er le trigger trg_audit_game_insert
--
-- Table: games
-- Moment: AFTER INSERT
--
-- Action:
-- Ins√©rer une ligne dans games_audit avec:
-- - game_id: NEW.id
-- - game_name: NEW.name
-- - operation: 'INSERT'
-- - operation_time: NOW()
--
-- üí° SYNTAXE POSTGRESQL:
-- -- √âtape 1: Table d'audit
-- CREATE TABLE IF NOT EXISTS games_audit (
--     audit_id SERIAL PRIMARY KEY,
--     game_id INT,
--     game_name VARCHAR(255),
--     operation VARCHAR(10),
--     operation_time TIMESTAMP DEFAULT NOW()
-- );
-- CREATE INDEX IF NOT EXISTS idx_audit_time ON games_audit(operation_time);
--
-- -- √âtape 2: Fonction trigger
-- CREATE OR REPLACE FUNCTION audit_game_insert()
-- RETURNS TRIGGER
-- LANGUAGE plpgsql
-- AS \$\$
-- BEGIN
--     INSERT INTO games_audit (game_id, game_name, operation, operation_time)
--     VALUES (NEW.id, NEW.name, 'INSERT', NOW());
--
--     RETURN NEW;  -- Pour AFTER triggers, valeur ignor√©e mais obligatoire
-- END;
-- \$\$;
--
-- -- √âtape 3: Trigger
-- CREATE TRIGGER trg_audit_game_insert
-- AFTER INSERT ON games
-- FOR EACH ROW
-- EXECUTE FUNCTION audit_game_insert();
--
-- üí° UTILISATION:
-- -- Ins√©rer un jeu
-- INSERT INTO games (name, year) VALUES ('Audited Game', 2023);
--
-- -- V√©rifier l'audit
-- SELECT * FROM games_audit WHERE operation = 'INSERT' ORDER BY operation_time DESC;
--
-- ‚ö†Ô∏è DIFF√âRENCES POSTGRESQL vs MariaDB:
-- 1. SERIAL au lieu de AUTO_INCREMENT
-- 2. TIMESTAMP au lieu de DATETIME
-- 3. Fonction s√©par√©e (RETURNS TRIGGER)
-- 4. CREATE INDEX IF NOT EXISTS (plus robuste)
-- 5. EXECUTE FUNCTION au lieu de code inline
--
-- üí° POURQUOI AFTER et pas BEFORE ?
-- AFTER INSERT garantit que:
-- - L'insertion a r√©ussi
-- - Les valeurs AUTO_INCREMENT (comme NEW.id) sont disponibles
-- - Les contraintes d'int√©grit√© sont v√©rifi√©es
--
-- üí° CAS D'USAGE R√âELS:
-- - Conformit√© r√©glementaire (banque, sant√©)
-- - Tra√ßabilit√© des modifications sensibles
-- - Statistiques d'utilisation
-- - D√©tection de fraudes
--
-- üí° POUR ALLER PLUS LOIN:
-- Ajouter des colonnes suppl√©mentaires:
-- - user_name VARCHAR(100) : qui a fait la modification
-- - ip_address INET : depuis quelle adresse
-- - old_value JSONB : ancienne valeur (pour UPDATE)
-- - new_value JSONB : nouvelle valeur
-- ============================================

