-- ============================================
-- EXERCICE: ProcÃ©dure avec gestion d'erreurs et transactions
-- NIVEAU: ðŸ”´ AvancÃ© - ProcÃ©dures StockÃ©es
-- CONCEPTS: Transactions, HANDLER, ROLLBACK, validation
--
-- ðŸ“š Documentation MariaDB :
-- - [Transactions](https://mariadb.com/kb/en/transactions/)
-- - [HANDLER](https://mariadb.com/kb/en/declare-handler/)
-- - [ROLLBACK](https://mariadb.com/kb/en/rollback/)
--
-- ðŸŽ¯ OBJECTIF PÃ‰DAGOGIQUE:
-- GÃ©rer les erreurs avec des HANDLER et utiliser des transactions
-- pour garantir l'intÃ©gritÃ© des donnÃ©es.
--
-- ðŸ’¡ TRANSACTIONS:
-- START TRANSACTION; -- DÃ©but
-- ... opÃ©rations ...
-- COMMIT; -- Valider
-- ROLLBACK; -- Annuler
--
-- ðŸ’¡ HANDLER FOR SQLEXCEPTION:
-- Capture toutes les erreurs SQL et permet de faire un rollback.
--
-- ============================================
-- CONSIGNE:
-- CrÃ©ez une procÃ©dure 'sp_insert_game_safe' qui insÃ¨re un jeu
-- avec validation et gestion d'erreurs.
--
-- Nom: sp_insert_game_safe
-- ParamÃ¨tres:
-- - IN game_name VARCHAR(255)
-- - IN game_year INT
-- - IN game_score INT
-- - OUT success BOOLEAN
-- - OUT error_msg VARCHAR(255)
--
-- Validations:
-- - year doit Ãªtre entre 1970 et annÃ©e courante
-- - score doit Ãªtre entre 0 et 100
--
-- En cas de succÃ¨s: success = TRUE, error_msg = 'Insertion rÃ©ussie'
-- En cas d'erreur: success = FALSE, error_msg = description de l'erreur
--
-- ðŸ’¡ STRUCTURE:
-- DELIMITER //
-- CREATE PROCEDURE sp_insert_game_safe(
--     IN game_name VARCHAR(255),
--     IN game_year INT,
--     IN game_score INT,
--     OUT success BOOLEAN,
--     OUT error_msg VARCHAR(255)
-- )
-- BEGIN
--     -- Handler pour les erreurs SQL
--     DECLARE EXIT HANDLER FOR SQLEXCEPTION
--     BEGIN
--         SET success = FALSE;
--         SET error_msg = 'Erreur SQL lors de l\'insertion';
--         ROLLBACK;
--     END;
--     
--     START TRANSACTION;
--     
--     -- Validations
--     IF game_year < 1970 OR game_year > YEAR(CURDATE()) THEN
--         SET success = FALSE;
--         SET error_msg = 'AnnÃ©e invalide';
--     ELSEIF game_score < 0 OR game_score > 100 THEN
--         SET success = FALSE;
--         SET error_msg = 'Score invalide';
--     ELSE
--         -- Insertion
--         INSERT INTO games (name, year, metacritic) 
--         VALUES (game_name, game_year, game_score);
--         
--         SET success = TRUE;
--         SET error_msg = 'Insertion rÃ©ussie';
--         COMMIT;
--     END IF;
-- END //
-- DELIMITER ;
--
-- ðŸ’¡ UTILISATION:
-- CALL sp_insert_game_safe('Test Game', 2023, 85, @ok, @msg);
-- SELECT @ok, @msg;
--
-- CALL sp_insert_game_safe('Bad Year', 1800, 85, @ok, @msg);
-- SELECT @ok, @msg;  -- Devrait retourner FALSE
-- ============================================
