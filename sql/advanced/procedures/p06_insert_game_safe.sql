-- ============================================
-- EXERCICE: Proc√©dure avec gestion d'erreurs et transactions
-- NIVEAU: üî¥ Avanc√© - Proc√©dures Stock√©es
-- CONCEPTS: Transactions, EXCEPTION, ROLLBACK, validation
--
-- üìö Documentation PostgreSQL :
-- - [Transactions](https://www.postgresql.org/docs/current/tutorial-transactions.html)
-- - [EXCEPTION](https://www.postgresql.org/docs/current/plpgsql-control-structures.html#PLPGSQL-ERROR-TRAPPING)
-- - [ROLLBACK](https://www.postgresql.org/docs/current/sql-rollback.html)
-- - [RAISE](https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html)
--
-- üéØ OBJECTIF P√âDAGOGIQUE:
-- G√©rer les erreurs avec des blocs EXCEPTION et utiliser des transactions
-- pour garantir l'int√©grit√© des donn√©es.
--
-- üí° TRANSACTIONS:
-- BEGIN; -- D√©but (implicite dans les proc√©dures)
-- ... op√©rations ...
-- COMMIT; -- Valider
-- ROLLBACK; -- Annuler
--
-- üí° EXCEPTION HANDLING:
-- BEGIN
--     -- code qui peut √©chouer
-- EXCEPTION
--     WHEN condition THEN
--         -- gestion d'erreur
-- END;
--
-- ============================================
-- CONSIGNE:
-- Cr√©ez une proc√©dure 'sp_insert_game_safe' qui ins√®re un jeu
-- avec validation et gestion d'erreurs.
--
-- Nom: sp_insert_game_safe
-- Param√®tres:
-- - IN game_name VARCHAR(255)
-- - IN game_year INT
-- - IN game_score INT
-- - INOUT success BOOLEAN
-- - INOUT error_msg VARCHAR(255)
--
-- Validations:
-- - year doit √™tre entre 1970 et ann√©e courante
-- - score doit √™tre entre 0 et 100
--
-- En cas de succ√®s: success = TRUE, error_msg = 'Insertion r√©ussie'
-- En cas d'erreur: success = FALSE, error_msg = description de l'erreur
--
-- üí° SYNTAXE POSTGRESQL:
-- CREATE OR REPLACE PROCEDURE sp_insert_game_safe(
--     IN game_name VARCHAR(255),
--     IN game_year INT,
--     IN game_score INT,
--     INOUT success BOOLEAN DEFAULT FALSE,
--     INOUT error_msg VARCHAR(255) DEFAULT NULL
-- )
-- LANGUAGE plpgsql
-- AS \$\$
-- BEGIN
--     -- Validations
--     IF game_year < 1970 OR game_year > EXTRACT(YEAR FROM CURRENT_DATE) THEN
--         success := FALSE;
--         error_msg := 'Ann√©e invalide';
--         RETURN;
--     END IF;
--
--     IF game_score < 0 OR game_score > 100 THEN
--         success := FALSE;
--         error_msg := 'Score invalide';
--         RETURN;
--     END IF;
--
--     -- Insertion (transaction implicite)
--     BEGIN
--         INSERT INTO games (name, year, metacritic)
--         VALUES (game_name, game_year, game_score);
--
--         success := TRUE;
--         error_msg := 'Insertion r√©ussie';
--     EXCEPTION
--         WHEN OTHERS THEN
--             success := FALSE;
--             error_msg := 'Erreur SQL: ' || SQLERRM;
--             -- ROLLBACK automatique en cas d'exception
--     END;
-- END;
-- \$\$;
--
-- üí° UTILISATION:
-- CALL sp_insert_game_safe('Test Game', 2023, 85, NULL, NULL);
--
-- CALL sp_insert_game_safe('Bad Year', 1800, 85, NULL, NULL);
-- -- Devrait retourner success = FALSE
--
-- ‚ö†Ô∏è DIFF√âRENCES POSTGRESQL vs MariaDB:
-- 1. EXCEPTION WHEN OTHERS au lieu de DECLARE EXIT HANDLER
-- 2. SQLERRM pour le message d'erreur (au lieu de MESSAGE_TEXT)
-- 3. EXTRACT(YEAR FROM CURRENT_DATE) au lieu de YEAR(CURDATE())
-- 4. RETURN pour sortir imm√©diatement
-- 5. ROLLBACK automatique en cas d'exception dans bloc BEGIN
-- 6. || pour concat√©nation au lieu de CONCAT()
--
-- üí° GESTION AVANC√âE DES ERREURS:
-- PostgreSQL permet de capturer des erreurs sp√©cifiques:
--
-- EXCEPTION
--     WHEN unique_violation THEN
--         error_msg := 'Ce jeu existe d√©j√†';
--     WHEN foreign_key_violation THEN
--         error_msg := 'R√©f√©rence invalide';
--     WHEN check_violation THEN
--         error_msg := 'Contrainte viol√©e';
--     WHEN OTHERS THEN
--         error_msg := 'Erreur inconnue: ' || SQLERRM;
-- END;
--
-- üí° SAVEPOINTS pour transactions imbriqu√©es:
-- BEGIN
--     SAVEPOINT my_savepoint;
--     -- op√©rations risqu√©es
--     ROLLBACK TO my_savepoint;  -- Revenir au savepoint
-- END;
-- ============================================

