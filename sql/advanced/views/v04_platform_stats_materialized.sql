-- ============================================
-- EXERCICE: Vue mat√©rialis√©e (stats plateformes)
-- NIVEAU: üî¥ Avanc√© - Vues
-- CONCEPTS: MATERIALIZED VIEW, performance, rafra√Æchissement
--
-- üìö Documentation PostgreSQL :
-- - [CREATE MATERIALIZED VIEW](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)
-- - [REFRESH MATERIALIZED VIEW](https://www.postgresql.org/docs/current/sql-refreshmaterializedview.html)
--
-- üéØ OBJECTIF P√âDAGOGIQUE:
-- D√©couvrir les vues mat√©rialis√©es natives de PostgreSQL qui
-- stockent physiquement les r√©sultats pour am√©liorer les performances.
--
-- üí° QU'EST-CE QU'UNE VUE MAT√âRIALIS√âE ?
-- Contrairement aux vues classiques, une vue mat√©rialis√©e:
-- - STOCKE les donn√©es physiquement (comme une table)
-- - Am√©liore les performances (pas de recalcul √† chaque SELECT)
-- - N√©cessite un rafra√Æchissement p√©riodique (REFRESH)
--
-- üìä Vue classique vs Vue mat√©rialis√©e:
-- Vue classique (VIEW):
--   ‚úÖ Toujours √† jour
--   ‚úÖ Pas d'espace disque
--   ‚ùå Recalcul √† chaque SELECT (lent)
--
-- Vue mat√©rialis√©e (MATERIALIZED VIEW):
--   ‚úÖ Tr√®s rapide (donn√©es stock√©es)
--   ‚úÖ Peut avoir des index
--   ‚ùå N√©cessite REFRESH pour mise √† jour
--   ‚ùå Occupe de l'espace disque
--
-- ‚ö†Ô∏è PostgreSQL vs MariaDB:
-- PostgreSQL a des vues mat√©rialis√©es NATIVES (facile!)
-- MariaDB n√©cessite simulation avec table + triggers (complexe)
--
-- ============================================
-- CONSIGNE:
-- Cr√©ez une vue mat√©rialis√©e 'view_platform_stats' avec stats par plateforme.
--
-- Colonnes:
-- - platform_code (VARCHAR) : code de la plateforme
-- - total_games (INT) : nombre de jeux
-- - avg_score (DECIMAL) : score moyen arrondi √† 2 d√©cimales
-- - best_game (VARCHAR) : nom du meilleur jeu
-- - best_score (INT) : score du meilleur jeu
--
-- Ordre:
-- - Par total_games DESC (plateformes avec le plus de jeux)
--
-- üí° SYNTAXE POSTGRESQL:
-- CREATE MATERIALIZED VIEW view_platform_stats AS
-- SELECT
--     p.code AS platform_code,
--     COUNT(*) AS total_games,
--     ROUND(AVG(g.metacritic), 2) AS avg_score,
--     (SELECT g2.name
--      FROM games g2
--      JOIN game_platforms gp2 ON g2.id = gp2.game_id
--      WHERE gp2.platform_id = p.id AND g2.metacritic IS NOT NULL
--      ORDER BY g2.metacritic DESC
--      LIMIT 1) AS best_game,
--     MAX(g.metacritic) AS best_score
-- FROM platforms p
-- JOIN game_platforms gp ON p.id = gp.platform_id
-- JOIN games g ON gp.game_id = g.id
-- WHERE g.metacritic IS NOT NULL
-- GROUP BY p.id, p.code
-- ORDER BY total_games DESC;
--
-- üí° UTILISATION:
-- -- Cr√©er la vue
-- CREATE MATERIALIZED VIEW view_platform_stats AS ...
--
-- -- Utiliser comme une table normale (tr√®s rapide)
-- SELECT * FROM view_platform_stats WHERE total_games > 100;
--
-- -- Rafra√Æchir les donn√©es
-- REFRESH MATERIALIZED VIEW view_platform_stats;
--
-- -- Rafra√Æchir sans bloquer les lectures (avec index UNIQUE)
-- REFRESH MATERIALIZED VIEW CONCURRENTLY view_platform_stats;
--
-- üí° INDEX sur vues mat√©rialis√©es:
-- CREATE UNIQUE INDEX idx_platform_stats_code
-- ON view_platform_stats(platform_code);
--
-- Cet index permet:
-- 1. REFRESH CONCURRENTLY (sans bloquer)
-- 2. Recherches rapides par platform_code
--
-- üí° QUAND UTILISER ?
-- ‚úÖ Requ√™tes complexes ex√©cut√©es fr√©quemment
-- ‚úÖ Donn√©es qui changent peu souvent
-- ‚úÖ Dashboards, rapports, analytics
-- ‚ùå Donn√©es temps r√©el (pr√©f√©rer vue classique)
-- ‚ùå Requ√™tes simples d√©j√† rapides
--
-- üí° STRAT√âGIES DE RAFRA√éCHISSEMENT:
-- 1. Manuel: REFRESH MATERIALIZED VIEW (bloquant)
-- 2. Concurrentiel: REFRESH MATERIALIZED VIEW CONCURRENTLY (non bloquant)
-- 3. P√©riodique: Cron job PostgreSQL (pg_cron)
-- 4. Trigger: REFRESH apr√®s INSERT/UPDATE (co√ªteux)
--
-- üí° AVANTAGES POSTGRESQL:
-- - Syntaxe simple et native
-- - Pas besoin de triggers complexes
-- - Support des index
-- - REFRESH CONCURRENTLY
-- - Int√©gr√© dans l'optimiseur de requ√™tes
--
-- üí° ALTERNATIVE avec pg_cron:
-- -- Installer pg_cron
-- CREATE EXTENSION pg_cron;
--
-- -- Rafra√Æchir toutes les heures
-- SELECT cron.schedule('refresh-platform-stats', '0 * * * *',
--   \$\$REFRESH MATERIALIZED VIEW CONCURRENTLY view_platform_stats\$\$);
--
-- üí° SUPPRIMER:
-- DROP MATERIALIZED VIEW IF EXISTS view_platform_stats;
-- ============================================

